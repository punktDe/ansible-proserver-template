---
- name: Template .env file
  template:
    src: neos.env
    dest: /usr/local/etc/neos.env
    owner: proserver
    group: proserver
    mode: 0400

- name: Create webspace directory
  file:
    path: "{{ item }}"
    state: directory
    owner: proserver
    group: proserver
  with_items:
    - /var/www
    - "{{ neos.prefix.current_release }}"
  register: create_webspace_directory

- name: Install Neos base distribution
  become_user: proserver
  composer:
    working_dir: "{{ item }}"
    command: create-project
    arguments: neos/neos-base-distribution .
  with_items:
    - "{{ neos.prefix.current_release }}"
  when: create_webspace_directory.changed
  register: composer_create_project

- name: Install dotenv-connector
  become_user: proserver
  composer:
    working_dir: "{{ item }}"
    command: require
    arguments: helhum/dotenv-connector ^2.1.2
  with_items:
    - "{{ neos.prefix.current_release }}"
  when: composer_create_project.changed
  register: dotenv_connector_result

- name: Configure dotenv-connector
  become_user: proserver
  composer:
    working_dir: "{{ item }}"
    command: config
    arguments: extra.helhum/dotenv-connector.env-file /usr/local/etc/neos.env
  with_items:
    - "{{ neos.prefix.current_release }}"
  when: dotenv_connector_result.changed
  register: composer_config_dotenv_connector_result

- name: Update composer autoloader
  become_user: proserver
  composer:
    working_dir: "{{ item }}"
    command: dump-autoload
  with_items:
    - "{{ neos.prefix.current_release }}"
  when: composer_config_dotenv_connector_result.changed

- name: Template Neos configuration file
  template:
    src: neos/Configuration/Settings.yaml
    dest: "{{ item }}"
    owner: proserver
    group: proserver
    mode: 0400
  with_items:
    - "{{ neos.prefix.current_release }}/Configuration/Settings.yaml"
  register: template_neos_configuration

- name: Clear Neos cache
  become_user: proserver
  command: ./flow flow:cache:flush
  args:
    chdir: "{{ item }}"
  with_items:
    - "{{ neos.prefix.current_release }}"
  when: template_neos_configuration.changed

- name: Execute Doctrine migrations
  become_user: proserver
  command: ./flow doctrine:migrate
  args:
    chdir: "{{ item }}"
  with_items:
    - "{{ neos.prefix.current_release }}"
  when: composer_create_project.changed
  register: doctrine_migrate_result

- name: Import demo site package
  become_user: proserver
  command: ./flow site:import --package-key Neos.Demo
  args:
    chdir: "{{ item }}"
  with_items:
    - "{{ neos.prefix.current_release }}"
  when: doctrine_migrate_result.changed

- name: Create demo user
  become_user: proserver
  command: ./flow user:create --username demo --password demo --first-name Demo --last-name Demo --roles Administrator
  args:
    chdir: "{{ item }}"
  with_items:
    - "{{ neos.prefix.current_release }}"
  when: doctrine_migrate_result.changed
